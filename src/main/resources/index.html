<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Voice Changer Control</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: 20px auto;
    padding: 10px;
    background: #f4f6f8;
  }
  h1 {
    text-align: center;
    color: #333;
  }
  .uuid-list {
    margin-bottom: 15px;
  }
  .uuid-row {
    display: flex;
    gap: 10px;
    margin-bottom: 8px;
  }
  .uuid-row input[type="text"] {
    flex-grow: 1;
    padding: 6px 8px;
    font-size: 1em;
  }
  .uuid-row button {
    padding: 6px 12px;
    font-size: 0.9em;
    cursor: pointer;
  }
  .actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  select {
    padding: 6px 10px;
    font-size: 1em;
  }
  #response {
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    max-height: 250px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 0.9em;
    margin-top: 10px;
  }
  button.primary {
    background-color: #1976d2;
    border: none;
    color: white;
    border-radius: 3px;
  }
  button.primary:hover {
    background-color: #115293;
  }
  button.danger {
    background-color: #d32f2f;
    border: none;
    color: white;
    border-radius: 3px;
  }
  button.danger:hover {
    background-color: #8b1a1a;
  }
  button.secondary {
    background-color: #555;
    border: none;
    color: white;
    border-radius: 3px;
  }
  button.secondary:hover {
    background-color: #333;
  }
</style>
</head>
<body>

<h1>Voice Changer Control</h1>

<button class="secondary" onclick="fetchActiveCalls()" style="margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto;">
  Load Active Calls UUIDs
</button>

<div class="uuid-list" id="uuidList">
  <div class="uuid-row">
    <input type="text" placeholder="Enter Call UUID" />
    <button onclick="removeUuid(this)" title="Remove this UUID">✖</button>
  </div>
</div>
<button onclick="addUuid()" style="margin-bottom: 20px;">+ Add another UUID</button>

<div class="actions">
  <button class="primary" onclick="controlVoiceChanger('start')">Start</button>

  <label for="pitchSelect" style="align-self: center;">Pitch:</label>
  <select id="pitchSelect">
    <option value="0.7">Very Low (0.7)</option>
    <option value="0.8">Low (0.8)</option>
    <option value="1.0" selected>Normal (1.0)</option>
    <option value="1.1">High (1.1)</option>
    <option value="1.2">Higher (1.2)</option>
    <option value="1.3">Very High (1.3)</option>
  </select>
  <button class="primary" onclick="controlVoiceChanger('set')">Set Pitch</button>

  <button class="danger" onclick="controlVoiceChanger('stop')">Stop</button>
</div>

<pre id="response" aria-live="polite" aria-atomic="true"></pre>

<script>
  const apiBase = 'http://localhost:8080/api/voicechanger';

  function addUuid() {
    const container = document.getElementById('uuidList');
    const div = document.createElement('div');
    div.className = 'uuid-row';
    div.innerHTML = `
      <input type="text" placeholder="Enter Call UUID" />
      <button onclick="removeUuid(this)" title="Remove this UUID">✖</button>
    `;
    container.appendChild(div);
  }

  function removeUuid(button) {
    const row = button.parentElement;
    const container = document.getElementById('uuidList');
    if (container.children.length > 1) {
      container.removeChild(row);
    } else {
      alert('At least one UUID is required.');
    }
  }

  async function fetchActiveCalls() {
    try {
      const res = await fetch(`${apiBase}/calls`);
      if (!res.ok) throw new Error(await res.text());
      const uuids = await res.json();

      const container = document.getElementById('uuidList');
      container.innerHTML = '';
      uuids.forEach(uuid => {
        const div = document.createElement('div');
        div.className = 'uuid-row';
        div.innerHTML = `
          <input type="text" value="${uuid}" />
          <button onclick="removeUuid(this)" title="Remove this UUID">✖</button>
        `;
        container.appendChild(div);
      });
      showResponse(`Loaded ${uuids.length} active UUID(s).`);
    } catch (err) {
      alert('Error fetching active calls: ' + err.message);
    }
  }

  async function controlVoiceChanger(command) {
    const uuids = Array.from(document.querySelectorAll('#uuidList input[type=text]'))
                       .map(input => input.value.trim())
                       .filter(Boolean);

    if (uuids.length === 0) {
      alert('Please enter at least one UUID.');
      return;
    }

    let value = null;
    if (command === 'set') {
      value = document.getElementById('pitchSelect').value;
      if (!value) {
        alert('Please select a pitch value.');
        return;
      }
    }

    const responses = [];
    showResponse('Sending commands...\n');

    for (const uuid of uuids) {
      let url = `${apiBase}?command=${command}&uuid=${encodeURIComponent(uuid)}`;
      if (value !== null) {
        url += `&value=${encodeURIComponent(value)}`;
      }

      try {
        const res = await fetch(url);
        const text = await res.text();
        if (!res.ok) {
          responses.push(`UUID: ${uuid} — Error ${res.status}: ${text}`);
        } else {
          responses.push(`UUID: ${uuid} — Success:\n${text.trim()}`);
        }
      } catch (err) {
        responses.push(`UUID: ${uuid} — Fetch error: ${err.message}`);
      }

      showResponse(responses.join('\n\n'));
    }
  }

  function showResponse(text) {
    document.getElementById('response').textContent = text;
  }
</script>

</body>
</html>
